# HTTP 框架开发计划

## 概述

本文档记录了 ZCO HTTP 框架的当前状态、已实现功能、进行中的工作和未来计划。

**文档版本**: 1.0  
**最后更新**: 2025年10月29日  
**当前版本**: v0.4.2

## 📊 项目状态总览

### ✅ 已完成功能

#### 核心功能
- [x] HTTP 服务器基础架构
  - 基于 ZCO 协程的异步 IO
  - TCP 连接管理
  - HTTP 请求解析
  - HTTP 响应构建

- [x] 路由系统
  - RESTful 路由支持 (GET, POST, PUT, DELETE, PATCH, OPTIONS, HEAD)
  - 路径参数解析 (`:name`)
  - 查询参数解析
  - 路由组和前缀支持

- [x] 中间件系统
  - 中间件链机制
  - 日志中间件
  - CORS 中间件
  - JWT 认证中间件（基础实现）

- [x] 请求处理
  - HTTP 方法解析
  - 请求头解析
  - 请求体读取
  - Content-Type 识别

- [x] 响应处理
  - 文本响应
  - JSON 响应（字符串形式）
  - HTML 响应
  - 状态码管理
  - 自定义响应头
  - Cookie 支持

- [x] JWT 认证
  - JWT Token 生成 (sign)
  - JWT Token 验证 (verify)
  - HS256 和 HS512 算法支持
  - Claims 管理（标准claims和自定义claims）
  - Base64URL 编码/解码

- [x] 文件上传
  - multipart/form-data 解析
  - 文件内容提取
  - 文件名和 Content-Type 提取
  - 文件保存功能

- [x] 静态文件服务
  - 文件读取和传输
  - MIME 类型识别
  - ETag 支持（基于文件大小）
  - If-None-Match 条件请求

- [x] 模板引擎
  - 基础变量替换
  - 模板文件读取

- [x] 上下文管理
  - 上下文数据存储
  - 上下文数据获取

- [x] WebSocket 升级支持
  - HTTP 升级检测
  - WebSocket 握手准备

#### 技术改进
- [x] Zig 0.14.0 兼容性
  - fmt 格式化错误修复
  - API 更新适配
  - 内存管理优化

- [x] 错误处理
  - 完整的错误类型定义
  - 错误处理和传播

- [x] 内存管理
  - 资源正确释放
  - defer 机制使用
  - 内存泄漏预防

### 🔧 进行中的工作

#### JWT 功能完善
- [ ] **JWT JSON 解析问题修复**
  - 状态: 已识别问题，等待修复
  - 位置: `http/src/jwt.zig` (verify 函数)
  - 问题: `std.json.parseFromSliceLeaky` 在 Zig 0.14.0 中存在格式化问题
  - 影响: JWT verify 函数中的 claims 解析暂时禁用
  - 临时方案: 返回空的 claims 结构

#### JSON 响应功能
- [ ] **JSON 自动序列化**
  - 状态: 已禁用，等待修复
  - 位置: `http/src/response.zig`, `http/src/context.zig`
  - 问题: `std.json.stringify` 在 Zig 0.14.0 中存在格式化问题
  - 当前方案: 使用 `jsonString` 手动构建 JSON 字符串
  - 计划: 在 Zig 版本更新或找到替代方案后恢复

#### 中间件功能
- [ ] **JWT 认证中间件完善**
  - 状态: 基础实现完成，等待 JSON 解析修复
  - 位置: `http/src/middleware.zig`
  - 当前限制: JWT verify 功能暂时禁用
  - 计划: 修复 JSON 解析后完善认证流程

### 📋 未来计划

#### 短期计划 (1-2 个月)

1. **修复 JSON 解析问题**
   - 目标: 恢复 JWT verify 中的 claims 解析
   - 方案: 
     - 等待 Zig 0.15.0 修复 JSON 格式化问题
     - 或使用第三方 JSON 库（如 `zap` 或 `json5`)
     - 或实现自定义 JSON 解析器

2. **JSON 响应自动序列化**
   - 目标: 实现 `ctx.json(status, data)` 自动序列化对象
   - 依赖: 修复 JSON 解析问题
   - 功能:
     ```zig
     const data = struct { name: []const u8, age: u32 }{ .name = "Alice", .age = 30 };
     try ctx.json(200, data);
     ```

3. **JWT 中间件完善**
   - 目标: 完整的 JWT 认证流程
   - 功能:
     - 自动从 Authorization header 提取 token
     - 验证 token 并解析 claims
     - 将 claims 注入到上下文
     - 错误处理和重定向

4. **请求体解析增强**
   - JSON 请求体自动解析
   - URL 编码表单数据解析
   - XML 请求体支持（可选）

#### 中期计划 (3-6 个月)

5. **路由功能增强**
   - 路由优先级支持
   - 路由中间件（针对特定路由的中间件）
   - 路由缓存优化
   - 动态路由匹配优化

6. **中间件生态**
   - 速率限制中间件 (Rate Limiting)
   - 请求压缩中间件
   - 请求日志中间件增强
   - 安全头中间件 (Helmet-like)
   - 会话管理中间件

7. **性能优化**
   - 连接池管理
   - 响应缓冲优化
   - 零拷贝文件传输
   - 内存池优化

8. **测试覆盖**
   - 单元测试覆盖
   - 集成测试
   - 性能基准测试
   - 压力测试

#### 长期计划 (6-12 个月)

9. **高级功能**
   - HTTP/2 支持
   - Server-Sent Events (SSE)
   - GraphQL 支持（可选）
   - gRPC 支持（可选）

10. **开发工具**
    - 代码生成工具（路由、类型定义）
    - 调试工具
    - 性能分析工具
    - API 文档自动生成

11. **框架生态**
    - ORM 集成示例
    - 数据库连接池
    - 缓存中间件 (Redis)
    - 消息队列集成

12. **文档和示例**
    - 完整的 API 文档
    - 最佳实践指南
    - 部署指南
    - 性能调优指南
    - 常见问题解答

## 🔍 技术债务

### 高优先级

1. **JSON 解析问题**
   - 问题: `std.json.parseFromSliceLeaky` 和 `std.json.stringify` 在 Zig 0.14.0 中存在格式化错误
   - 影响: JWT verify 和 JSON 自动序列化功能受限
   - 优先级: 高
   - 预计解决时间: 等待 Zig 0.15.0 或找到替代方案

2. **内存管理优化**
   - 问题: 部分场景可能存在不必要的内存分配
   - 改进: 使用内存池减少分配次数
   - 优先级: 中

### 中优先级

3. **错误处理一致性**
   - 问题: 部分错误处理可以更加统一
   - 改进: 建立错误处理规范
   - 优先级: 中

4. **代码注释**
   - 问题: 部分复杂逻辑缺少注释
   - 改进: 补充中文文档注释
   - 优先级: 低

### 低优先级

5. **代码重构**
   - 问题: 部分代码可以进一步模块化
   - 改进: 提取公共功能，减少重复
   - 优先级: 低

## 📈 版本计划

### v0.5.0 (计划中)
- [ ] 修复 JSON 解析问题
- [ ] 恢复 JWT verify 完整功能
- [ ] JSON 自动序列化
- [ ] JWT 中间件完善
- [ ] 请求体 JSON 解析

### v0.6.0 (计划中)
- [ ] 路由功能增强
- [ ] 中间件生态扩展
- [ ] 性能优化
- [ ] 测试覆盖

### v1.0.0 (长期)
- [ ] HTTP/2 支持
- [ ] 完整文档
- [ ] 生产环境验证
- [ ] API 稳定性保证

## 🛠️ 开发指南

### 贡献指南

1. **代码风格**
   - 遵循 Zig 官方代码风格
   - 使用 4 个空格缩进
   - 函数名 camelCase，类型名 PascalCase
   - 变量名 snake_case

2. **注释规范**
   - 公共 API 必须提供中文文档注释
   - 复杂逻辑需要行内注释
   - 使用 `///` 进行文档注释

3. **错误处理**
   - 所有可能失败的操作必须处理错误
   - 使用 Zig 的错误处理机制
   - 提供有意义的错误信息

4. **测试要求**
   - 新功能必须包含测试
   - 修复 bug 必须添加回归测试
   - 保持测试覆盖率

### 问题反馈

遇到问题请通过以下方式反馈：

1. **GitHub Issues**: 报告 bug 和功能请求
2. **代码审查**: 提交 Pull Request 前进行代码审查
3. **文档改进**: 发现文档问题可以直接提交 PR

## 📚 相关文档

- [HTTP 框架 README](../http/README.md) - 使用指南和 API 参考
- [FMT 格式化排查指南](./FMT_FORMATTING_TROUBLESHOOTING.md) - Zig fmt 格式化问题排查
- [性能优化指南](./PERFORMANCE_OPTIMIZATION_GUIDE.md) - 性能优化建议
- [协程时间片抢占设计](./analysis/TIMESLICE_PREEMPTION_DESIGN.md) - 调度器设计文档

## 📝 更新日志

### 2025-10-29
- ✅ 修复 Zig 0.14.0 fmt 格式化错误
- ✅ 恢复所有 fmt 格式化功能
- ✅ 添加开发计划文档
- ✅ 整理项目状态和技术债务

### 2025-10-28
- ✅ 实现 HTTP 框架基础功能
- ✅ 实现 JWT 认证（签名功能完整）
- ✅ 实现文件上传
- ✅ 实现静态文件服务

---

**注意**: 本文档会随着项目进展持续更新。建议定期查看以了解最新状态。

