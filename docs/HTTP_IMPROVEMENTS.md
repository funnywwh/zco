# HTTP æ¡†æž¶æ”¹è¿›è®¡åˆ’

## å½“å‰çŠ¶æ€

âœ… **å·²å®žçŽ°**ï¼š
- HTTP keep-alive æ”¯æŒ
- åŸºæœ¬çš„è¯·æ±‚/å“åº”å¤„ç†
- ä¸­é—´ä»¶ç³»ç»Ÿ
- è·¯ç”±ç³»ç»Ÿ
- JWTã€æ–‡ä»¶ä¸Šä¼ ã€é™æ€æ–‡ä»¶ç­‰æœåŠ¡

## å¾…æ”¹è¿›é¡¹

### é«˜ä¼˜å…ˆçº§ ðŸ”´

#### 1. è¯·æ±‚åˆ†ç‰‡å’Œç²˜åŒ…å¤„ç†

**é—®é¢˜**ï¼š
- å½“å‰å®žçŽ°å‡è®¾ä¸€æ¬¡ `read()` è¯»å–å®Œæ•´çš„ HTTP è¯·æ±‚
- åœ¨ keep-alive æ¨¡å¼ä¸‹ï¼Œå¯èƒ½é‡åˆ°ï¼š
  - **ç²˜åŒ…**ï¼šå¤šä¸ªè¯·æ±‚åœ¨åŒä¸€ä¸ª TCP æ•°æ®åŒ…ä¸­
  - **åˆ†åŒ…**ï¼šä¸€ä¸ªè¯·æ±‚åˆ†æˆå¤šä¸ª TCP æ•°æ®åŒ…

**æ”¹è¿›æ–¹æ¡ˆ**ï¼š
```zig
// éœ€è¦å®žçŽ°è¯·æ±‚è¾¹ç•Œæ£€æµ‹
fn readCompleteRequest(client: *nets.Tcp, buffer: []u8) !usize {
    var total_read: usize = 0;
    var header_end: ?usize = null;
    
    while (true) {
        const n = try client.read(buffer[total_read..]);
        total_read += n;
        
        // æŸ¥æ‰¾ "\r\n\r\n" ç¡®å®šå¤´éƒ¨ç»“æŸ
        if (std.mem.indexOf(u8, buffer[0..total_read], "\r\n\r\n")) |pos| {
            header_end = pos + 4;
            
            // æ£€æŸ¥æ˜¯å¦æœ‰ Content-Length
            // å¦‚æžœæœ‰ï¼Œç»§ç»­è¯»å–ç›´åˆ°è¾¾åˆ°æŒ‡å®šé•¿åº¦
            // å¦‚æžœæ²¡æœ‰ï¼Œå¤´éƒ¨ç»“æŸå°±æ˜¯è¯·æ±‚ç»“æŸï¼ˆGETè¯·æ±‚ï¼‰
            break;
        }
        
        if (total_read >= buffer.len) {
            return error.BufferTooSmall;
        }
    }
    
    return total_read;
}
```

**å½±å“**ï¼šä¿®å¤åŽå¯ä»¥æ­£ç¡®å¤„ç†åˆ†ç‰‡å’Œç²˜åŒ…ï¼Œæé«˜ç¨³å®šæ€§

#### 2. Content-Length å®Œæ•´è¯»å–

**é—®é¢˜**ï¼š
- å½“å‰å¦‚æžœè¯·æ±‚ä½“è¾ƒå¤§ï¼Œå¯èƒ½ä¸€æ¬¡è¯»å–ä¸å®Œæ•´
- éœ€è¦æ ¹æ® Content-Length ç»§ç»­è¯»å–

**æ”¹è¿›æ–¹æ¡ˆ**ï¼š
- è§£æž HTTP å¤´éƒ¨åŽï¼Œæ£€æŸ¥ Content-Length
- å¦‚æžœæŒ‡å®šäº†é•¿åº¦ï¼Œç»§ç»­è¯»å–ç›´åˆ°è¾¾åˆ°æŒ‡å®šé•¿åº¦
- å¦‚æžœæ²¡æœ‰ Content-Lengthï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯ chunked ç¼–ç 

### ä¸­ä¼˜å…ˆçº§ ðŸŸ¡

#### 3. è¿žæŽ¥è¶…æ—¶å’Œé™æµ

**é—®é¢˜**ï¼š
- é•¿æ—¶é—´ç©ºé—²çš„è¿žæŽ¥å ç”¨èµ„æº
- æ²¡æœ‰æœ€å¤§è¿žæŽ¥æ•°é™åˆ¶
- å¯èƒ½å¯¼è‡´èµ„æºè€—å°½

**æ”¹è¿›æ–¹æ¡ˆ**ï¼š
```zig
// æ·»åŠ è¿žæŽ¥è¶…æ—¶
const KEEP_ALIVE_TIMEOUT = 30 * std.time.ns_per_s; // 30ç§’
var last_request_time: std.time.Instant = undefined;

// åœ¨æ¯æ¬¡è¯·æ±‚åŽæ›´æ–°
last_request_time = try std.time.Instant.now();

// åœ¨è¯»å–å‰æ£€æŸ¥
const elapsed = (try std.time.Instant.now()).since(last_request_time);
if (elapsed > KEEP_ALIVE_TIMEOUT) {
    // è¶…æ—¶ï¼Œå…³é—­è¿žæŽ¥
    break;
}

// æœ€å¤§è¿žæŽ¥æ•°é™åˆ¶
const MAX_CONNECTIONS = 10000;
var active_connections: std.atomic.Value(usize) = std.atomic.Value(usize).init(0);
```

#### 4. ç¼“å†²åŒºæ± åŒ–

**é—®é¢˜**ï¼š
- æ¯ä¸ªè¿žæŽ¥éƒ½åˆ†é…æ–°çš„ 8KB ç¼“å†²åŒº
- é¢‘ç¹åˆ†é…/é‡Šæ”¾å¯¼è‡´å»¶è¿Ÿ

**æ”¹è¿›æ–¹æ¡ˆ**ï¼š
- ä½¿ç”¨ç¼“å†²åŒºæ± å¤ç”¨ç¼“å†²åŒº
- å‡å°‘å†…å­˜åˆ†é…å¼€é”€

### ä½Žä¼˜å…ˆçº§ ðŸŸ¢

#### 5. HTTP/1.1 Chunked ç¼–ç æ”¯æŒ

**é—®é¢˜**ï¼š
- å½“å‰ä¸æ”¯æŒ Transfer-Encoding: chunked
- å¯¹å¤§æ•°æ®ä¼ è¾“ä¸å‹å¥½

#### 6. HTTP/2 æ”¯æŒ

**é—®é¢˜**ï¼š
- ä»…æ”¯æŒ HTTP/1.1
- HTTP/2 å¯ä»¥æä¾›æ›´å¥½çš„æ€§èƒ½

#### 7. è¯·æ±‚åŽ‹ç¼©ï¼ˆgzip/deflateï¼‰

**é—®é¢˜**ï¼š
- å“åº”æ²¡æœ‰åŽ‹ç¼©
- å¯¹æ–‡æœ¬å†…å®¹ï¼ˆHTMLã€JSONï¼‰å¯ä»¥æ˜¾è‘—å‡å°‘ä¼ è¾“é‡

## æ€§èƒ½ä¼˜åŒ–è·¯çº¿å›¾

### Phase 1: åŸºç¡€ç¨³å®šæ€§ï¼ˆå½“å‰é˜¶æ®µï¼‰
- [x] HTTP keep-alive
- [ ] è¯·æ±‚åˆ†ç‰‡å¤„ç†
- [ ] Content-Length å®Œæ•´è¯»å–

### Phase 2: èµ„æºç®¡ç†
- [ ] è¿žæŽ¥è¶…æ—¶
- [ ] è¿žæŽ¥æ•°é™åˆ¶
- [ ] ç¼“å†²åŒºæ± åŒ–

### Phase 3: é«˜çº§ç‰¹æ€§
- [ ] Chunked ç¼–ç 
- [ ] å“åº”åŽ‹ç¼©
- [ ] HTTP/2 æ”¯æŒ

## æµ‹è¯•å»ºè®®

### 1. Keep-Alive æµ‹è¯•

```bash
# æµ‹è¯• keep-alive æ˜¯å¦ç”Ÿæ•ˆ
curl -v http://127.0.0.1:8080/ 2>&1 | grep -i connection

# åº”è¯¥çœ‹åˆ°ï¼šConnection: keep-alive
```

### 2. å¤šè¯·æ±‚æµ‹è¯•

```bash
# åˆ›å»ºåŒ…å«å¤šä¸ªè¯·æ±‚çš„æ–‡ä»¶
cat > requests.txt <<EOF
GET / HTTP/1.1
Host: 127.0.0.1:8080

GET / HTTP/1.1
Host: 127.0.0.1:8080

EOF

# é€šè¿‡ netcat å‘é€
cat requests.txt | nc 127.0.0.1 8080
```

### 3. åŽ‹åŠ›æµ‹è¯•

```bash
# ä½¿ç”¨ wrk æµ‹è¯• keep-alive
wrk -t12 -c400 -d30s http://127.0.0.1:8080/

# ä½¿ç”¨ vegeta
echo "GET http://127.0.0.1:8080/" | vegeta attack -duration=30s -rate=1000 | vegeta report
```

## å‚è€ƒå®žçŽ°

å‚è€ƒ `nets/src/main.zig` ä¸­çš„ä¼˜åŒ–å®žçŽ°ï¼š
- ä½¿ç”¨åç¨‹æ± å¤„ç†è¿žæŽ¥
- ç¼“å†²åŒºå¤ç”¨
- å¿«é€Ÿè·¯å¾„ä¼˜åŒ–
- é›¶æ‹·è´ä¼˜åŒ–

---

**æœ€åŽæ›´æ–°**: 2025å¹´10æœˆ29æ—¥

